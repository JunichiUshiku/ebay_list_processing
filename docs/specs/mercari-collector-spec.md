# メルカリ同一商品検索サブエージェント仕様書

**バージョン**: 2.0.0
**作成日**: 2026-01-16
**ステータス**: 実装完了

---

## 1. 概要

### 1.1 目的

メルカリで商品検索し、ローカル参照画像と同一商品かをVision比較して結果をJSON返却するサブエージェント。

### 1.2 スコープ

| 項目 | 内容 |
|------|------|
| 対象サイト | https://jp.mercari.com/ |
| 処理対象 | 販売中商品のみ |
| 実行方式 | ヘッドレスブラウザ（agent-browser） |
| 画像保存 | **なし**（メモリ内比較のみ） |

### 1.3 ファイル構成

```
.claude/
├── agents/
│   └── mercari-matcher.md        # サブエージェント定義

images/
└── Target-Product/               # 参照画像格納ディレクトリ（固定）
    └── {商品名}.jpg

docs/specs/
├── mercari-collector-spec.md     # 本仕様書
└── thumbnail-sticker.md          # 売り切れ判定仕様
```

---

## 2. インターフェース仕様

### 2.1 入力パラメータ

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|------------|-----|------|-----------|------|
| `keyword` | string | ✓ | - | 検索キーワード |
| `reference_dir` | string | - | `images/Target-Product/` | 参照画像ディレクトリ |
| `max_items` | number | - | 10 | 検査件数上限 |

### 2.2 返却JSONスキーマ（固定）

```json
{
  "success": true,
  "input": {
    "keyword": "検索キーワード",
    "reference_images": ["images/Target-Product/xxx.jpg"]
  },
  "matches": [
    {
      "url": "https://jp.mercari.com/item/m12345678",
      "price": "¥5,000",
      "title": "商品名",
      "confidence": "high"
    }
  ],
  "checked_count": 10,
  "error": null
}
```

**失敗時**:
```json
{
  "success": false,
  "input": { ... },
  "matches": [],
  "checked_count": 0,
  "error": "CAPTCHA検出により中断"
}
```

### 2.3 呼び出しトリガー

以下のフレーズでサブエージェントが自動呼び出しされる:

- 「メルカリで同一商品を探して」
- 「メルカリで〇〇と同じ商品を検索」
- 「mercari match」
- 「メルカリ照合」

---

## 3. 技術仕様

### 3.1 使用ツール

| ツール | 用途 |
|--------|------|
| agent-browser | ブラウザ自動操作（ヘッドレス） |
| Claude Vision | 画像比較・同一商品判定 |
| WebFetch | 商品画像取得（メモリ内） |

### 3.2 セッション管理

```
┌─────────────────────────────────────┐
│  mercari セッション（単一）          │
├─────────────────────────────────────┤
│ 検索 → 商品詳細 → 画像取得 → 比較   │
└─────────────────────────────────────┘
```

**設計原則**:
- 単一セッション方式
- 画像はダウンロードせずメモリ内で比較

---

## 4. 売り切れ判定仕様

### 4.1 判定方法

**採用**: `data-testid="thumbnail-sticker"` による構造ベース判定

| 商品状態 | `thumbnail-sticker` | 判定 |
|----------|---------------------|------|
| 販売中 | 存在しない | `=== null` |
| 売り切れ | 存在する | `!== null` |

### 4.2 判定コード

```javascript
// 販売中商品のみ抽出
Array.from(document.querySelectorAll('a[href*="/item/"]'))
  .filter(a => !a.querySelector('[data-testid="thumbnail-sticker"]'))
  .map(a => ({
    url: a.href,
    id: a.href.split('/').pop(),
    price: a.textContent.match(/¥[\d,]+/)?.[0] || ''
  }))
  .slice(0, max_items)
```

---

## 5. ワークフロー詳細

### 5.1 処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│ Step 0: 初期化                                              │
│   - 参照画像をTarget-Product/から読み込み                   │
│   - パラメータ検証                                          │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 1: メルカリ検索                                        │
│   - トップページアクセス                                    │
│   - キーワード検索実行                                      │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 販売中商品リスト抽出                                │
│   - thumbnail-sticker判定で販売中のみ抽出                   │
│   - 商品ID・URL・価格を取得                                 │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 商品詳細ページで全画像取得                          │
│   - 各商品の詳細ページにアクセス                            │
│   - ページ内の全商品画像URLを取得                           │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 4: Vision比較（全画像精査）                            │
│   - 参照画像と各商品の全画像を比較                          │
│   - 同一商品判定: 型番・形状・色・特徴                      │
│   - confidence: high / medium / low                         │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 5: JSON返却                                            │
│   - 固定スキーマでメインエージェントに返却                  │
│   - 一致商品のURL・価格・confidence                         │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 画像URL取得JavaScript

```javascript
// 詳細ページの全商品画像を取得
Array.from(document.querySelectorAll('img'))
  .map(img => img.src)
  .filter(src => src.includes('static.mercdn.net') && src.includes('/photos/'))
  .filter((v,i,a) => a.indexOf(v) === i)
```

---

## 6. confidence判定基準

| レベル | 条件 | 例 |
|--------|------|-----|
| **high** | 同一商品確定 | 型番・形状・色・状態が完全一致 |
| **medium** | 同一商品の可能性高 | 主要特徴は一致、細部に差異 |
| **low** | 類似商品 | 同シリーズだが別モデル |

**判定に使用する要素**:
- 型番・モデル名（画像内テキスト）
- 形状・サイズ比率
- 色・素材感
- 付属品・パッケージ
- 使用感・傷の位置

---

## 7. エラーハンドリング

### 7.1 エラー種別と対応

| エラー | 検出方法 | 対応 | error値 |
|--------|----------|------|---------|
| 参照画像なし | Glob結果が空 | 即時終了 | "参照画像が見つかりません" |
| 検索結果0件 | 抽出結果が空 | 正常終了 | null（matches: []） |
| ページタイムアウト | 10秒経過 | リトライ3回 | "タイムアウト" |
| CAPTCHA出現 | reCAPTCHA検出 | 処理中断 | "CAPTCHA検出により中断" |

### 7.2 リトライ戦略

```
1回目失敗 → 2秒待機 → リトライ
2回目失敗 → 5秒待機 → リトライ
3回目失敗 → 10秒待機 → リトライ
4回目失敗 → エラー記録してJSON返却
```

---

## 8. CRITICAL RULES

実装時に必ず遵守すべきルール:

1. **画像ダウンロード禁止**: ローカル保存せず、メモリ内で比較のみ
2. **詳細ページ全画像精査**: サムネイルではなく詳細ページの全画像を使用
3. **固定JSONスキーマ**: 必ず指定のスキーマで返却
4. **売り切れ判定はdata-testid**: `thumbnail-sticker` の有無で判定
5. **agent-browser使用**: Chrome MCP不使用、JS制限なし

---

## 9. テスト計画

### 9.1 テストケース

| テスト | 入力 | 期待結果 |
|--------|------|----------|
| 基本動作 | keyword + 参照画像あり | 同一商品のURL・価格を返却 |
| 一致なし | keyword + 無関係な参照画像 | success: true, matches: [] |
| 参照画像なし | Target-Product/が空 | success: false, error設定 |

### 9.2 検証コマンド

```bash
# サブエージェントファイル存在確認
ls -la .claude/agents/mercari-matcher.md

# 参照画像ディレクトリ確認
ls -la images/Target-Product/
```

---

## 10. 参考資料

| 資料 | パス |
|------|------|
| 売り切れ判定仕様 | `docs/specs/thumbnail-sticker.md` |
| サブエージェント定義 | `.claude/agents/mercari-matcher.md` |
| プラン詳細 | `.claude/plans/curious-launching-minsky.md` |

---

## 11. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0.0 | 2026-01-16 | 初版作成（画像ダウンロード方式） |
| 2.0.0 | 2026-01-16 | **Vision比較方式に変更、画像ダウンロード廃止** |
