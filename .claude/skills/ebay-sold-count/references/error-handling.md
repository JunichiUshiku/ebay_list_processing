# エラーハンドリング詳細

## 目次

1. [エラー種別と対応](#エラー種別と対応)
2. [検出コード](#検出コード)
3. [リトライ戦略](#リトライ戦略)

---

## エラー種別と対応

| エラー種別 | 検出方法 | 対応 | 記録値 |
|------------|----------|------|--------|
| URL形式不正 | `_nkw=`なし | 次へスキップ | 「URLエラー」 |
| ログイン切れ | innerText検出 | 処理中断 | ユーザー通知 |
| CAPTCHA出現 | iframe検出 | 処理中断 | ユーザー通知 |
| 検索結果なし | DOM検出 | 正常終了 | 0（リンク付き） |
| ページタイムアウト | 10秒経過 | リトライ3回 | 「タイムアウト」 |
| DOM要素未検出 | querySelector失敗 | リトライ3回 | 「取得エラー」 |
| 書き込み失敗 | MCP例外 | リトライ2回 | ログ出力 |

---

## 検出コード

### CAPTCHA検出

```javascript
!!document.querySelector('iframe[title*="reCAPTCHA"]') ||
!!document.querySelector('.g-recaptcha') ||
document.body.innerText.includes('確認が必要です')
```

戻り値: `true` = CAPTCHA出現（処理中断が必要）

### ログイン切れ検出

```javascript
document.body.innerText.includes('Sign in') ||
document.body.innerText.includes('Hello! Sign in')
```

戻り値: `true` = ログイン画面にリダイレクト

**注意**: MCPセキュリティ制限により `window.location.href` は使用不可

### 検索結果なし検出

```javascript
!!document.querySelector('.research-table__no-results')
```

戻り値: `true` = 検索結果0件（Total Sold = 0として記録）

### ロード完了検出

```javascript
!!document.querySelector('.research-table-row__totalSoldCount') ||
!!document.querySelector('.research-table__no-results')
```

戻り値: `true` = ロード完了

---

## リトライ戦略

### リトライ間隔

| 回数 | 間隔 |
|------|------|
| 1回目 | 2秒 |
| 2回目 | 5秒 |
| 3回目 | 10秒 |
| 失敗 | エラー記録、次の行へ |

### リトライ対象

- ページタイムアウト: 最大3回
- DOM要素未検出: 最大3回
- 書き込み失敗: 最大2回

### リトライ非対象（即時中断）

- ログイン切れ
- CAPTCHA出現
- URL形式不正

---

## エラー発生時の対応フロー

### ログイン切れ/CAPTCHA検出時

1. 処理を即時中断
2. ユーザーに通知:
   - ログイン切れ: 「eBayへの再ログインが必要です」
   - CAPTCHA: 「CAPTCHAの手動解除が必要です」
3. 処理済み件数をサマリー報告
4. LINE通知送信（エラー内容を含む）

### タイムアウト/DOM未検出時

1. リトライ間隔で待機
2. 再度ナビゲート/取得を試行
3. 3回失敗 → エラー記録、次の行へ
4. 全件処理後にエラー行をサマリー報告

---

## エラー記録形式

### スプレッドシートへの記録

| エラー種別 | X列記録値 |
|------------|-----------|
| URLエラー | `URLエラー` |
| タイムアウト | `タイムアウト` |
| 取得エラー | `取得エラー` |
| 検索結果なし | `=HYPERLINK("URL", "0")` |

### サマリー報告形式

```
## 結果

| 項目 | 結果 |
|------|------|
| 処理件数 | 50件 |
| 成功 | 47件 |
| エラー | 3件 |

### エラー詳細
- 行15: タイムアウト
- 行28: URLエラー
- 行42: 取得エラー
```

---

## サブエージェントエラーハンドリング（パラレルモード）

### サブエージェント起動失敗時のリトライ

**⚠️ CRITICAL**: サブエージェントが起動しない場合は以下のリトライポリシーに従う

| 状況 | 対応 |
|------|------|
| 一部エージェント起動失敗 | 失敗分のみ再起動（最大3回） |
| 3回リトライ後も失敗 | **メインエージェントがその分を担当** |
| 全エージェント起動失敗 | メインエージェントが全件処理 |

**リトライフロー**:
```
Task(agent1) ✅ 成功
Task(agent2) ❌ 起動失敗
Task(agent3) ✅ 成功

↓ agent2のみリトライ

Task(agent2) リトライ1回目 ❌ 失敗
Task(agent2) リトライ2回目 ❌ 失敗
Task(agent2) リトライ3回目 ❌ 失敗

↓ 3回失敗 → メインエージェントがフォールバック

メインエージェント: agent2の担当分（5件）を処理
- Step 3-S の手順でタブ作成
- Step 4 の手順で通常処理
- 結果を agent1, agent3 の結果と統合
```

**フォールバック時の注意**:
- メインエージェントはシングルモードと同じ手順で処理
- 他のサブエージェント結果と統合して最終結果を作成
- LINE通知・サマリーには全結果を含める

### エラー種別と対応（起動後）

| エラー種別 | 対応 | メインへの影響 |
|------------|------|---------------|
| 一部アイテム失敗 | 失敗分を記録、他は続行 | 結果に含める |
| ログイン切れ | 該当エージェント中断 | 部分結果を統合 |
| CAPTCHA | 該当エージェント中断 | 部分結果を統合 |
| エージェント応答なし | タイムアウト扱い | エラーとして記録 |

### サブエージェント失敗時の結果統合

```javascript
// 一部エージェント失敗の例
const results = [
  { success: true, agent_id: 1, processed: [...], summary: {total: 5, success: 5, error: 0} },
  { success: false, agent_id: 2, processed: [...], summary: {total: 5, success: 2, error: 3}, error: "CAPTCHA検出" },
  { success: true, agent_id: 3, processed: [...], summary: {total: 5, success: 5, error: 0} }
];

// 統合結果
// total: 15, success: 12, error: 3
// 部分的に完了したAgent2の2件も含める
```

### 全エージェント失敗時のフォールバック

```javascript
if (allResults.every(r => !r.success)) {
  console.log("全エージェント失敗 → シングルモードで再試行を検討");

  // オプション1: シングルモードで再試行
  // skill-state.json の mode を "single" に変更
  // Step 3-S から再開

  // オプション2: ユーザーに通知して中断
  // 「全サブエージェントが失敗しました。手動でeBayにログインしてからリトライしてください」
}
```

### サブエージェント別エラーサマリー

```
## パラレル処理結果

| エージェント | 担当件数 | 成功 | 失敗 | 状態 |
|-------------|---------|------|------|------|
| Agent1 | 5件 | 5件 | 0件 | ✅ 完了 |
| Agent2 | 5件 | 2件 | 3件 | ⚠️ 部分完了（CAPTCHA） |
| Agent3 | 5件 | 5件 | 0件 | ✅ 完了 |

総合: 15件中12件成功（80%）
```

### タブ競合エラー

複数エージェントが同じタブを使用しようとした場合：

| 状況 | 原因 | 対応 |
|------|------|------|
| タブID重複 | パラメータ設定ミス | エージェント再起動 |
| タブ消失 | ユーザーがタブを閉じた | 新規タブ作成・再割当 |

**防止策**: 起動時に各エージェントに専用タブIDを明示的に割り当て

```
Agent1: tab_ids: [101, 102, 103, 104, 105]
Agent2: tab_ids: [106, 107, 108, 109, 110]
Agent3: tab_ids: [111, 112, 113, 114, 115]
```
